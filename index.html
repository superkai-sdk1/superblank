<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Game</title>
    <link rel="stylesheet" href="css/mafia.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/drupal.js"></script>
    <script src="js/table.js"></script>
    <script src="js/players.js"></script>
    <script src="js/timer.js"></script>
    <script src="js/game.js"></script>
    <link rel="manifest" href="/manifest.json">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="/images/icon/apple-touch-icon.png">
    <link rel="android-chrome-192x192" href="/images/icon/android-chrome-192x192.png">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        $(document).ready(function() {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.MainButton.text = "Начать игру";
            tg.MainButton.show();
            tg.MainButton.onClick(function() {
                alert('Telegram MainButton clicked!');
            });
        });

        function collectGameResults() {
            let results = [];
            document.querySelectorAll('.main-game-table tbody tr').forEach(row => {
                const number = row.querySelector('.col1').textContent.trim();
                const nickname = row.querySelector('.nick_acpl').value.trim();
                const role = row.querySelector('.role').textContent.trim();
                const lh = row.querySelector('.lh-button')?.textContent.trim() || '';
                const points = row.querySelector('.form-item .form-text').value.trim();
                const addPoints = row.querySelector('.col7 .form-text').value.trim();
                const total = row.querySelector('.col8').textContent.trim();

                if (nickname) {
                    results.push({
                        number,
                        nickname,
                        role,
                        lh,
                        points,
                        addPoints,
                        total
                    });
                }
            });

            const winner = document.querySelector('#winner_field').value === 'm' ? 'Победа Мафия' : 'Победа Мирные';
            return { results, winner };
        }

        async function sendGameResultsToTelegram(results, winner) {
            const botToken = '7656955712:AAGsnp8Wh8xqw3YhXH2pFKZMm89x6gL8axA';
            const chatId = window.Telegram.WebApp.initDataUnsafe.user.id;
            const message = results.map(result => 
                `(${result.number})|(${result.nickname})|(${result.role})|(${result.lh})|(${result.points})|(${result.addPoints})|(${result.total})`
            ).join('\n') + `\n${winner}`;

            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message
                })
            });

            if (!response.ok) {
                console.error('Failed to send message to Telegram:', response.status, response.statusText);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('saveGameButton').addEventListener('click', async () => {
                const { results, winner } = collectGameResults();
                await sendGameResultsToTelegram(results, winner);
                alert('Итоги игры отправлены в Telegram');
            });
        });
    </script>
</head>
<body>
<div class="timer-container">
    <div id="timer-display" class="timer-display">00:00</div>
    <div class="timer-controls">
        <button class="material-button large-button" onclick="startTimer(60)">1 мин</button>
        <button class="material-button large-button" onclick="startTimer(30)">30 сек</button>
        <button class="material-button large-button" onclick="pauseTimer()">Пауза</button>
        <button class="material-button large-button" onclick="resumeTimer()">Продолжить</button>
        <button class="material-button large-button" onclick="stopTimer()">Стоп</button>
    </div>
</div>
<div class="main-game-table-wrapper table-wrapper">
    <!-- Таблица с участниками игры -->
</div>
<div class="vote-wrapper">
    <div class="vote-table-wrapper">
        <table class="vote-table" cellspacing="5">
            <tbody>
            <!-- Строки голосования -->
            <tr id="save_day">
                <td class="voute_line" colspan="7">Сохранить день</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="vote_res" data-line="0">
    <div id="vr_l0" data-day="0" style="display:none;" class="vote_day"></div>
</div>
<div class="menu-content" id="menuContent">
    <button class="menu-cont-button" id="settingsToggle">Роли и баллы</button>
    <button class="menu-cont-button" id="shuffleButton">Рассадка</button>
    <button class="menu-cont-button" id="distributeButton">Распределить роли</button>
    <button type="button" class="menu-cont-button" id="mafia">Победа Мафии</button>
    <button type="button" class="menu-cont-button" id="citizens">Победа Мирных</button>
    <button class="menu-cont-button" id="resetAllForms">Новая игра</button>
    <button class="menu-cont-button" id="saveGameButton">Сохранить игру</button>
</div>
<div id="selection-modal" class="modal">
    <div class="modal-content">
        <h2>Введите лучший ход</h2>
        <div class="player-buttons">
            <button class="player-button" data-player="1">1</button>
            <button class="player-button" data-player="2">2</button>
            <button class="player-button" data-player="3">3</button>
            <button class="player-button" data-player="4">4</button>
            <button class="player-button" data-player="5">5</button>
            <button class="player-button" data-player="6">6</button>
            <button class="player-button" data-player="7">7</button>
            <button class="player-button" data-player="8">8</button>
            <button class="player-button" data-player="9">9</button>
            <button class="player-button" data-player="10">10</button>
        </div>
        <button id="save-selection" class="settings-toggle-button">Принять ЛХ</button>
        <div class="error-message" style="display: none;">Нельзя выбрать более трех кандидатов!</div>
    </div>
</div>
</body>
</html>
